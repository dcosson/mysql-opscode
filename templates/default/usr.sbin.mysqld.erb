# vim:syntax=apparmor
# Generated by Chef for <%= node['hostname'] %>
#include <tunables/global>

/usr/sbin/mysqld {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  #include <abstractions/user-tmp>
  #include <abstractions/mysql>
  #include <abstractions/winbind>

  capability dac_override,
  capability sys_resource,
  capability setgid,
  capability setuid,

  network tcp,

  /etc/hosts.allow r,
  /etc/hosts.deny r,

  <%= node['mysql']['conf_dir'] %>/*.pem r,
  <%= node['mysql']['confd_dir'] %>/ r,
  <%= node['mysql']['confd_dir'] %>/* r,
  <%= node['mysql']['conf_dir'] %>/*.cnf r,
  <%= node['mysql']['basedir'] %>/lib/mysql/plugin/ r,
  <%= node['mysql']['basedir'] %>/lib/mysql/plugin/*.so* mr,
  <%= node['mysql']['basedir'] %>/sbin/mysqld mr,
  <%= node['mysql']['basedir'] %>/share/mysql/** r,
  /var/log/mysql.log rw,
  /var/log/mysql.err rw,
  /var/lib/mysql/ r,
  /var/lib/mysql/** rwk,
  <%= @data_dir_no_symlink %>/ r,
  <%= @data_dir_no_symlink %>/** rwk,
  /var/log/mysql/ r,
  /var/log/mysql/* rw,

  <%= node['mysql']['pid_file'] %> rw,
  <%= node['mysql']['socket'] %> rw,
  <% if node['platform'] == 'ubuntu' && node['platform_version'].to_f >= 11.10 %>
  <%= node['mysql']['pid_file'].sub('/var/run', '/run') %> rw,
  <%= node['mysql']['socket'].sub('/var/run', '/run')  %> rw,
  <% end %>

  /sys/devices/system/cpu/ r,

  <% if node['platform'] == 'ubuntu' && node['platform_version'].to_f >= 11.10 %>
  # Site-specific additions and overrides. See local/README for details.
  #include <local/usr.sbin.mysqld>
  <% end %>
}
